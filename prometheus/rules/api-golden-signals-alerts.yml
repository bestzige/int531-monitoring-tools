groups:
  - name: api-golden-signals
    rules:
      # =====================================================
      # AVAILABILITY
      # =====================================================
      - alert: ApiDown
        expr: |
          up{job="api"} == 0
        for: 1m
        labels:
          severity: critical
          service: api
        annotations:
          title: 'API Down'
          description: 'Prometheus cannot scrape the API target.'
          runbook: 'runbooks/api-golden-signals.md#availability'

      # =====================================================
      # TRAFFIC
      # =====================================================
      - alert: ApiHighTraffic
        expr: |
          sum(rate(api_http_requests_total{service="api"}[5m])) > 100
        for: 10m
        labels:
          severity: warning
          service: api
        annotations:
          title: 'API High Traffic'
          description: 'Request rate above 100 req/s for 10 minutes.'
          runbook: 'runbooks/api-golden-signals.md#traffic'

      # =====================================================
      # LATENCY
      # =====================================================
      - alert: ApiHighLatencyP95
        expr: |
          histogram_quantile(
            0.95,
            sum by (le) (
              rate(api_http_request_duration_seconds_bucket{service="api"}[5m])
            )
          ) > 1
        for: 3m
        labels:
          severity: warning
          service: api
        annotations:
          title: 'High API Latency (p95)'
          description: '95th percentile latency is above 1 second.'
          runbook: 'runbooks/api-golden-signals.md#latency'

      - alert: ApiHighLatencyP99
        expr: |
          histogram_quantile(
            0.99,
            sum by (le) (
              rate(api_http_request_duration_seconds_bucket{service="api"}[5m])
            )
          ) > 2
        for: 2m
        labels:
          severity: critical
          service: api
        annotations:
          title: 'High API Latency (p99)'
          description: '99th percentile latency is above 2 seconds.'
          runbook: 'runbooks/api-golden-signals.md#latency'

      - alert: ApiTooManySlowRequests
        expr: |
          (
            sum(rate(api_http_request_duration_seconds_bucket{le="1",service="api"}[5m]))
            /
            sum(rate(api_http_request_duration_seconds_count{service="api"}[5m]))
          ) < 0.9
        for: 3m
        labels:
          severity: warning
          service: api
        annotations:
          title: 'Too Many Slow Requests'
          description: 'More than 10% of requests exceed 1 second.'
          runbook: 'runbooks/api-golden-signals.md#latency'

      # =====================================================
      # ERRORS
      # =====================================================

      # Immediate signal: any 500 per route
      - alert: ApiRoute500Error
        expr: |
          sum by (method, route) (
            increase(api_http_requests_total{status="500",service="api"}[1m])
          ) > 0
        for: 1m
        labels:
          severity: critical
          service: api
        annotations:
          title: 'API 500 Error'
          description: |
            500 error detected.
            Method: {{ $labels.method }}
            Route: {{ $labels.route }}
          runbook: 'runbooks/api-golden-signals.md#errors'

      # Spike-based alert (noise resistant)
      - alert: ApiRoute500Spike
        expr: |
          sum by (method, route) (
            rate(api_http_requests_total{status="500",service="api"}[1m])
          ) > 1
        for: 1m
        labels:
          severity: critical
          service: api
        annotations:
          title: 'API 500 Error Spike'
          description: |
            High rate of 500 errors.
            Method: {{ $labels.method }}
            Route: {{ $labels.route }}
          runbook: 'runbooks/api-golden-signals.md#errors'

      # Error rate per route
      - alert: ApiRouteHighErrorRate
        expr: |
          (
            sum by (method, route) (
              rate(api_http_requests_total{status=~"5..",service="api"}[5m])
            )
            /
            sum by (method, route) (
              rate(api_http_requests_total{service="api"}[5m])
            )
          ) > 0.10
        for: 2m
        labels:
          severity: critical
          service: api
        annotations:
          title: 'High API Error Rate'
          description: |
            5xx error rate above 10%.
            Method: {{ $labels.method }}
            Route: {{ $labels.route }}
          runbook: 'runbooks/api-golden-signals.md#error-budget'

      # =====================================================
      # SATURATION
      # =====================================================
      - alert: ApiHighSaturation
        expr: |
          max(api_http_requests_in_flight{service="api"}) > 50
        for: 3m
        labels:
          severity: warning
          service: api
        annotations:
          title: 'High API Saturation'
          description: 'Too many in-flight requests.'
          runbook: 'runbooks/api-golden-signals.md#saturation'
