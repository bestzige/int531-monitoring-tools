groups:
  - name: mariadb-alerts
    rules:
      # =====================================================
      # AVAILABILITY
      # =====================================================
      - alert: MariaDBDown
        expr: |
          up{job="mariadb"} == 0 || (mysql_up == 0)
        for: 2m
        labels:
          severity: critical
          service: mariadb
        annotations:
          title: 'ðŸ”´ MariaDB Down'
          description: 'MariaDB exporter is unreachable for more than 2 minutes.'
          runbook: 'runbooks/mariadb.md#down'

      # =====================================================
      # CONNECTIONS
      # =====================================================
      - alert: MariaDBTooManyConnections
        expr: |
          (
            mysql_global_status_threads_connected
            /
            mysql_global_variables_max_connections
          ) > 0.80
        for: 5m
        labels:
          severity: warning
          service: mariadb
        annotations:
          title: 'ðŸ”Œ MariaDB High Connections'
          description: 'Connections > 80% of max_connections for 5 minutes.'
          runbook: 'runbooks/mariadb.md#connections'

      - alert: MariaDBConnectionExhaustion
        expr: |
          (
            mysql_global_status_threads_connected
            /
            mysql_global_variables_max_connections
          ) > 0.95
        for: 2m
        labels:
          severity: critical
          service: mariadb
        annotations:
          title: 'ðŸš¨ MariaDB Connection Exhaustion'
          description: 'Connections > 95%, new clients may be rejected.'
          runbook: 'runbooks/mariadb.md#connections'

      # =====================================================
      # SLOW / HEAVY QUERIES
      # =====================================================
      - alert: MariaDBSlowQueries
        expr: |
          rate(mysql_global_status_slow_queries[5m]) > 1
        for: 5m
        labels:
          severity: warning
          service: mariadb
        annotations:
          title: 'ðŸŒ MariaDB Slow Queries Increasing'
          description: 'Slow queries > 1/sec for 5 minutes.'
          runbook: 'runbooks/mariadb.md#slow'

      - alert: MariaDBQueryLatencyDegraded
        expr: |
          rate(mysql_global_status_questions[5m]) > 0
          and
          rate(mysql_global_status_slow_queries[5m])
          /
          rate(mysql_global_status_questions[5m]) > 0.10
        for: 5m
        labels:
          severity: critical
          service: mariadb
        annotations:
          title: 'â± MariaDB Query Latency Degraded'
          description: 'More than 10% of queries are slow.'
          runbook: 'runbooks/mariadb.md#slow'

      # =====================================================
      # INNODB BUFFER POOL
      # =====================================================
      - alert: MariaDBHighBufferPoolUsage
        expr: |
          (
            mysql_global_status_innodb_buffer_pool_bytes_data
            /
            mysql_global_variables_innodb_buffer_pool_size
          ) > 0.90
        for: 10m
        labels:
          severity: warning
          service: mariadb
        annotations:
          title: 'ðŸ§  InnoDB Buffer Pool High Usage'
          description: 'Buffer pool usage > 90% for 10 minutes.'
          runbook: 'runbooks/mariadb.md#bufferpool'

      - alert: MariaDBBufferPoolCritical
        expr: |
          (
            mysql_global_status_innodb_buffer_pool_bytes_data
            /
            mysql_global_variables_innodb_buffer_pool_size
          ) > 0.97
        for: 5m
        labels:
          severity: critical
          service: mariadb
        annotations:
          title: 'ðŸš¨ InnoDB Buffer Pool Critical'
          description: 'Buffer pool nearly full (>97%), risk of disk reads.'
          runbook: 'runbooks/mariadb.md#bufferpool'
