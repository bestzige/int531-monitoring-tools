groups:
  - name: node-alerts
    rules:
      # =====================================================
      # AVAILABILITY
      # =====================================================
      - alert: NodeDown
        expr: up{job="node-exporter"} == 0
        for: 2m
        labels:
          severity: critical
          service: node
        annotations:
          title: >-
            üî¥ Node Down
            ({{ if $labels.node }}{{ $labels.node }}{{ else }}{{ $labels.instance }}{{ end }})
          description: 'Node exporter unreachable. VM may be down or unreachable.'
          runbook: 'runbooks/node.md#down'

      # =====================================================
      # CPU ‚Äì SATURATION / LATENCY
      # =====================================================
      - alert: NodeHighCpuUsage
        expr: |
          1 - avg by (instance, node) (
            rate(node_cpu_seconds_total{mode="idle"}[5m])
          ) > 0.80
        for: 5m
        labels:
          severity: warning
          service: node
        annotations:
          title: 'üî• High CPU Usage ({{ $labels.node }})'
          description: 'CPU usage > 80% for 5 minutes.'
          runbook: 'runbooks/node.md#cpu'

      - alert: NodeCpuCritical
        expr: |
          1 - avg by (instance, node) (
            rate(node_cpu_seconds_total{mode="idle"}[5m])
          ) > 0.95
        for: 2m
        labels:
          severity: critical
          service: node
        annotations:
          title: 'üö® CPU Saturated ({{ $labels.node }})'
          description: 'CPU usage > 95%, scheduling latency expected.'
          runbook: 'runbooks/node.md#cpu'

      # =====================================================
      # MEMORY ‚Äì SATURATION
      # =====================================================
      - alert: NodeHighMemoryUsage
        expr: |
          (node_memory_MemAvailable_bytes
            / node_memory_MemTotal_bytes) < 0.15
        for: 5m
        labels:
          severity: warning
          service: node
        annotations:
          title: 'üß† High Memory Usage ({{ $labels.node }})'
          description: 'Available memory < 15%.'
          runbook: 'runbooks/node.md#memory'

      - alert: NodeMemoryCritical
        expr: |
          (node_memory_MemAvailable_bytes
            / node_memory_MemTotal_bytes) < 0.05
        for: 2m
        labels:
          severity: critical
          service: node
        annotations:
          title: 'üö® Memory Exhaustion ({{ $labels.node }})'
          description: 'Available memory < 5%, OOM risk.'
          runbook: 'runbooks/node.md#memory'

      # =====================================================
      # DISK ‚Äì SATURATION / ERRORS
      # =====================================================
      - alert: NodeDiskAlmostFull
        expr: |
          (node_filesystem_avail_bytes{fstype!~"tmpfs|overlay"}
            / node_filesystem_size_bytes{fstype!~"tmpfs|overlay"}) < 0.15
        for: 10m
        labels:
          severity: warning
          service: node
        annotations:
          title: 'üíæ Disk Almost Full ({{ $labels.node }})'
          description: 'Disk space < 15%.'
          runbook: 'runbooks/node.md#disk'

      - alert: NodeDiskCritical
        expr: |
          (node_filesystem_avail_bytes{fstype!~"tmpfs|overlay"}
            / node_filesystem_size_bytes{fstype!~"tmpfs|overlay"}) < 0.05
        for: 2m
        labels:
          severity: critical
          service: node
        annotations:
          title: 'üö® Disk Full ({{ $labels.node }})'
          description: 'Disk space < 5%, writes may fail.'
          runbook: 'runbooks/node.md#disk'

      # =====================================================
      # LOAD ‚Äì TRAFFIC / SATURATION
      # =====================================================
      - alert: NodeHighLoad
        expr: |
          node_load15
          / count by (instance, node) (node_cpu_seconds_total{mode="idle"}) > 1
        for: 10m
        labels:
          severity: warning
          service: node
        annotations:
          title: 'üìà High System Load ({{ $labels.node }})'
          description: 'Load15 exceeds CPU core count.'
          runbook: 'runbooks/node.md#load'

      # =====================================================
      # IO WAIT ‚Äì LATENCY
      # =====================================================
      - alert: NodeHighIOWait
        expr: |
          avg by (instance, node) (
            rate(node_cpu_seconds_total{mode="iowait"}[5m])
          ) > 0.20
        for: 5m
        labels:
          severity: warning
          service: node
        annotations:
          title: '‚è± High IO Wait ({{ $labels.node }})'
          description: 'Disk IO wait > 20%, storage latency suspected.'
          runbook: 'runbooks/node.md#disk'

      # =====================================================
      # NETWORK ‚Äì ERRORS
      # =====================================================
      - alert: NodeNetworkErrors
        expr: |
          rate(node_network_receive_errs_total[5m]) > 1
          or
          rate(node_network_transmit_errs_total[5m]) > 1
        for: 5m
        labels:
          severity: warning
          service: node
        annotations:
          title: 'üåê Network Errors ({{ $labels.node }})'
          description: 'Network packet errors detected.'
          runbook: 'runbooks/node.md#network'
